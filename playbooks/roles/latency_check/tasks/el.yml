---
- name: Copy RDMA wait script
  become: true
  template:
    src: wait_rdma_ready.sh.j2
    dest: /tmp/wait_rdma_ready.sh
    owner: root
    group: root
    mode: "0755"

- name: Wait until RDMA interface is ready on all nodes
  become: true
  command: /tmp/wait_rdma_ready.sh
  register: rdma_wait
  retries: 30         # 4s * 30 ≈ 120s（スクリプト内部は240sまで粘る）
  delay: 4
  until: rdma_wait.rc == 0

- name: copy script
  template:
    src: latency_check.sh.j2
    dest: '/tmp/latency_check.sh'
    backup: yes
    owner: opc
    group: opc
    mode: 0775
  run_once: true

- name: Run Latency test
  command: "/tmp/latency_check.sh"
  register: latency_check
  failed_when: "'KO' in latency_check.stdout"
  run_once: true
  retries: 3
  delay: 10
  until: latency_check is not failed
